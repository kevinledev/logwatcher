<!DOCTYPE html>
<html>
  <head>
    <title>Event Log</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming"></script>
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background-color: #f5f5f5;
      }
      .error {
        color: #dc3545;
      }
      .success {
        color: #28a745;
      }
      .button {
        padding: 10px 20px;
        margin: 10px;
        cursor: pointer;
      }
      .generating {
        background-color: #dc3545;
      }
      .not-generating {
        background-color: #28a745;
      }
      #pagination-row {
        background-color: #f8f9fa;
      }

      #pagination-row button {
        margin: 5px;
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        background-color: white;
        cursor: pointer;
      }

      #pagination-row button:hover {
        background-color: #e9ecef;
      }
    </style>
    <script>
      let isGenerating = {{ is_generating|lower }};
      const eventSource = new EventSource('/stream/events/');

      // Listen for new events and update the table
      eventSource.addEventListener('api.request', function(e) {
        if (!isGenerating) return;

        const data = JSON.parse(e.data);
        if (!data.timestamp) return;

        // Update table with new row
        const tbody = document.querySelector("table tbody");
        const firstRow = tbody.querySelector("tr");
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
          <td>${new Date(data.timestamp).toLocaleString()}</td>
          <td>${data.method}</td>
          <td>${data.source}</td>
          <td class="${data.status_code >= 400 ? "error" : "success"}">${data.status_code}</td>
          <td>${data.duration_ms}ms</td>
          <td>${data.status_code >= 400 ? data.metadata.error_message : "Success"}</td>
        `;

        if (firstRow) {
          tbody.insertBefore(newRow, firstRow);
        } else {
          tbody.appendChild(newRow);
        }

        // Keep pagination count correct
        const rows = tbody.querySelectorAll("tr:not(#pagination-row)");
        if (rows.length > 10) {
          rows[rows.length - 1].remove();
        }
      });
    </script>
  </head>
  <body>
    <h1>Event Log</h1>

    <button
      id="generateBtn"
      class="button {% if is_generating %}generating{% else %}not-generating{% endif %}"
      onclick="toggleGeneration()"
    >
      {% if is_generating %}Stop Generation{% else %}Start Generation{% endif %}
    </button>

    <!-- Charts -->
    {% include "dashboard/charts/latency.html" %}

    <!-- Event Table -->
    {% include "dashboard/table/base.html" %}

    <!-- Generation controls -->
    <script>
      async function toggleGeneration() {
        const btn = document.getElementById('generateBtn');
        const endpoint = isGenerating ? '/generator/stop/' : '/generator/start/';

        try {
          await fetch(endpoint);
          isGenerating = !isGenerating;

          btn.textContent = isGenerating ? 'Stop Generation' : 'Start Generation';
          btn.classList.toggle('generating');
          btn.classList.toggle('not-generating');

          if (!isGenerating) {
            latencyChart.update();
          }
        } catch (error) {
          console.error('Error toggling generation:', error);
        }
      }
    </script>
  </body>
</html>
