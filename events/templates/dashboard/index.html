{% load static %}

<!DOCTYPE html>
<html lang="en" data-bs-core="modern">
  <head>
    <title>Event Log</title>
    <link href="{% static 'css/halfmoon.min.css' %}" rel="stylesheet" />

    <!-- Your other scripts -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.1/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0/dist/chartjs-plugin-streaming.min.js"></script>
    <script src="{% static 'js/streamHandler.js' %}"></script>

    
 
    <!-- Halfmoon modern core theme -->
    <link href="https://cdn.jsdelivr.net/npm/halfmoon@2.0.2/css/cores/halfmoon.modern.css" rel="stylesheet" integrity="sha256-DD6elX+jPmbFYPsGvzodUv2+9FHkxHlVtQi0/RJVULs=" crossorigin="anonymous">
 
    <script>
      let isGenerating = {{ is_generating|lower }};
      const streamHandler = new StreamHandler();
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>
  <body class="with-custom-webkit-scrollbars with-custom-css-scrollbars">
    <div>
      <nav class="navbar expand-md sticky-top">
        <div class="container-fluid px-4 py-2">
          <span class="logo">Log Watcher</span>
          <div class="d-flex align-items-center gap-2">
            <!-- Live Indicator -->
            <div id="liveIndicator">
              <span class="badge text-bg-light d-flex align-items-center">
                {% if is_generating %}
                  <span class="spinner-grow spinner-grow-sm me-1 text-success" role="status" aria-hidden="true"></span>
                {% else %}
                  <span class="me-1 text-danger">●</span>
                {% endif %}
                {% if is_generating %}Live{% else %}Stopped{% endif %}
              </span>
            </div>
            <button
              id="generateBtn"
              class="btn w-full {% if is_generating %}btn-danger{% else %}btn-primary{% endif %}"
              onclick="toggleGeneration()"
              >{% if is_generating %}Stop Stream{% else %}Start Stream{% endif %}
            </button>
          </div>
        </div>
      </nav>


        <div class="container-fluid p-4">
          <div class="row g-3 mb-4">
            <div class="col-12 col-xl-6">
              <div class="card h-full">
                <div class="p-3">
                  {% include "dashboard/charts/latency.html" %}
                </div>
              </div>
            </div>
            <div class="col-12 col-xl-6">
              <div class="card h-full">
                <div class="p-3">
                  {% include "dashboard/charts/error_rate.html" %}
                </div>
              </div>
            </div>
          </div>

          <!-- Event Table -->
          <div class="card"
               id="event-table-container"
               hx-get="{% url 'table_rows' %}" 
               hx-trigger="load"
               hx-swap="innerHTML">
          </div>
        
        </div>
      </div>


    <!-- Generation controls -->
    <script>
      async function toggleGeneration() {
        const btn = document.getElementById('generateBtn');
        const liveIndicator = document.getElementById('liveIndicator');
        const endpoint = isGenerating ? '/stream/stop/' : '/stream/start/';

        try {
          console.log(`[Toggle] Current state: ${isGenerating}, calling ${endpoint}`);
          const response = await fetch(endpoint);
          const data = await response.json();
          console.log('[Toggle] Server response:', data);
          
          isGenerating = !isGenerating;
          console.log(`[Toggle] New state: ${isGenerating}`);

          if (isGenerating) {
            streamHandler.connect();
            liveIndicator.querySelector('.badge').innerHTML = '<span class="spinner-grow spinner-grow-sm me-1 text-success" role="status" aria-hidden="true"></span> Live';
          } else {
            await streamHandler.disconnect();
            liveIndicator.querySelector('.badge').innerHTML = '<span class="me-1 text-danger">●</span> Stopped';
          }

          btn.textContent = isGenerating ? 'Stop Stream' : 'Start Stream';
          btn.classList.toggle('btn-danger');
          btn.classList.toggle('btn-primary');
        } catch (error) {
          console.error('[Toggle] Error:', error);
        }
      }
    </script>
  </body>
</html>


<style>
  .navbar{
    background-color: hsla(var(--bs-body-bg-hsl), 0.75);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-bottom: var(--bs-border-width) solid var(--bs-content-border-color);
  }
    .logo {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    font-weight: 600;
    font-size: 1.125rem;
    letter-spacing: -0.02em;
    color: var(--bs-body-color);
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  /* Optional dot accent */
  .logo::before {
    content: "•";
    color: var(--bs-primary);
    font-size: 2em;
    line-height: 0;
    position: relative;
    top: -0.05em;
  }
</style>