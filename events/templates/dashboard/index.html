{% load static %}

<!DOCTYPE html>
<html data-bs-theme="light">
  <head>
    <title>Event Log</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.1/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0/dist/chartjs-plugin-streaming.min.js"></script>
    <script src="{% static 'js/StreamHandler.js' %}"></script>
    <link href="https://cdn.jsdelivr.net/npm/halfmoon@2.0.1/css/halfmoon.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/halfmoon@2.0.1/js/halfmoon.min.js"></script>
    <script>
      let isGenerating = {{ is_generating|lower }};
      const streamHandler = new StreamHandler();
    </script>
  </head>
  <body>
    <div>
      <nav class="navbar">
        <div class="container-fluid">
          <h1 class="m-0">Event Log</h1>
          <button
            id="generateBtn"
            class="btn w-full {% if is_generating %}btn-danger{% else %}btn-primary{% endif %}"
            onclick="toggleGeneration()"
            >{% if is_generating %}Stop Generation{% else %}Start Generation{% endif %}
          </button>
        </div>
      </nav>


        <div class="container-fluid p-4">
          <div class="row g-3 mb-4">
            <div class="col-12 col-xl-6">
              <div class="card h-full">
                <div class="p-3">
                  {% include "dashboard/charts/latency.html" %}
                </div>
              </div>
            </div>
            <div class="col-12 col-xl-6">
              <div class="card h-full">
                <div class="p-3">
                  {% include "dashboard/charts/error_rate.html" %}
                </div>
              </div>
            </div>
          </div>

          <!-- Event Table -->
          <div class="card"
               id="event-table-container"
               hx-get="{% url 'table_rows' %}" 
               hx-trigger="load"
               hx-swap="innerHTML">
          </div>
        
        </div>
      </div>


    <!-- Generation controls -->
    <script>
      async function toggleGeneration() {
        const btn = document.getElementById('generateBtn');
        const endpoint = isGenerating ? '/stream/stop/' : '/stream/start/';

        try {
          await fetch(endpoint);
          isGenerating = !isGenerating;

          if (isGenerating) {
            streamHandler.connect();
          } else {
            streamHandler.disconnect();
          }

          btn.textContent = isGenerating ? 'Stop Generation' : 'Start Generation';
          btn.classList.toggle('btn-danger');
          btn.classList.toggle('btn-primary');

          document.dispatchEvent(new CustomEvent('generationStateChanged', {
            detail: { isGenerating }
          }));
        } catch (error) {
          console.error('Error toggling generation:', error);
        }
      }
    </script>
  </body>
</html>
