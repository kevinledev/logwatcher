<div class="card-body table-responsive">
  <table class="table table-hover table">
    <thead>
      <tr>
        <th style="width: 20%">Timestamp</th>
        <th style="width: 10%">Method</th>
        <th style="width: 15%">Source</th>
        <th style="width: 10%">Status</th>
        <th style="width: 10%">Duration</th>
        <th style="width: 50%">Details</th>
      </tr>
    </thead>
    <tbody>
      {% for event in events %}
      <tr>
        <td style="width: 20%">{{ event.timestamp|date:"m/d/Y, g:i:s A" }}</td>
        <td style="width: 5%">{{ event.method }}</td>
        <td style="width: 15%">{{ event.source }}</td>
        <td style="width: 10%">{{ event.status_code }}</td>
        <td style="width: 10%">{{ event.duration_ms }}ms</td>
        <td style="width: 50%">
          {% if event.status_code >= 400 %} {{ event.metadata.error_message }}
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if events %}
  <nav class="d-flex justify-content-end align-items-center gap-4" aria-label="Event list navigation">

    <form class="input-group input-group-sm specific-w-150"
      hx-get="{% url 'table_rows' %}"
      hx-target="#event-table-container"
      hx-trigger="submit">
        <span class="input-group-text">Page</span>
        <input type="number"
          name="page"
          class="form-control"
          aria-label="Page number input"
          min="1"
          max="{{ events.paginator.num_pages }}" />
        <button type="submit" class="btn btn-primary">
          Go
        </button>
    </form>


    <ul class="pagination pagination-sm m-0">
      {% if events.has_previous %}
      <li class="page-item">
        <a class="page-link" style="cursor: pointer"
          hx-get="{% url 'table_rows' %}?page=1"
          hx-target="#event-table-container"
          aria-label="First">
          First
        </a>
      </li>
      <li class="page-item">
        <a
          class="page-link"
          style="cursor: pointer"
          hx-get="{% url 'table_rows' %}?page={{ events.previous_page_number }}"
          hx-target="#event-table-container"
          aria-label="Previous"
        >
          &lt;
        </a>
      </li>
      {% endif %}

      <li class="page-item active" aria-current="page">
        <a class="page-link">{{ events.number }}</a>
      </li>

      {% if events.has_next %}
      <li class="page-item">
        <a
          class="page-link"
          style="cursor: pointer"
          hx-get="{% url 'table_rows' %}?page={{ events.next_page_number }}"
          hx-target="#event-table-container"
          aria-label="Next"
        >
          &gt;
        </a>
      </li>
      <li class="page-item">
        <a
          class="page-link"
          style="cursor: pointer"
          hx-get="{% url 'table_rows' %}?page={{ events.paginator.num_pages }}"
          hx-target="#event-table-container"
          aria-label="Last"
        >
          Last
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>

  {% endif %}
</div>

<script>
  // Clean up any existing subscription for this table
  if (window.currentTableSubscription) {
    streamHandler.unsubscribe(window.currentTableSubscription);
  }

  // Create new subscription and store its ID
  window.currentTableSubscription = streamHandler.subscribe(
    (data) => {
      const activePage = document.querySelector('.page-item.active .page-link');
      if (!activePage || activePage.textContent.trim() === '1') {
        const tbody = document.querySelector("table tbody");
        const firstRow = tbody.querySelector("tr");
        const newRow = document.createElement("tr");
        
        const isError = data.status >= 400;
        newRow.classList.add(isError ? 'highlight-error' : 'highlight-success');

        newRow.innerHTML = `
            <td>${data.time.toLocaleString()}</td>
            <td>${data.method}</td>
            <td>${data.source}</td>
            <td>${data.status}</td>
            <td>${data.duration}ms</td>
            <td>${data.message}</td>
        `;

        if (firstRow) {
          tbody.insertBefore(newRow, firstRow);
        } else {
          tbody.appendChild(newRow);
        }

        const rows = tbody.querySelectorAll("tr");
        if (rows.length > 15) {
          rows[rows.length - 1].remove();
        }
      }
    },
    { buffered: false }
  );
</script>

<style>
.highlight-success {
    animation: highlightSuccess 0.5s ease-out;  /* Reduced from 2s to 0.5s */
}

.highlight-error {
    animation: highlightError 0.5s ease-out;  /* Reduced from 2s to 0.5s */
}

@keyframes highlightSuccess {
    0% {
        opacity: 0;
        background-color: rgba(59, 130, 246, 0.2);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
        background-color: transparent;
    }
}

@keyframes highlightError {
    0% {
        opacity: 0;
        background-color: rgba(220, 38, 38, 0.2);
    }
    100% {
        opacity: 1;
        background-color: transparent;
    }
}
</style>